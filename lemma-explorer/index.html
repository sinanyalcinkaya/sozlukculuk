<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>İnce Memed — Lemma Gezgini</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600&family=JetBrains+Mono:wght@400;600&display=swap');
:root{--bg:#faf8f5;--fg:#2c2416;--ac:#8b4513;--ac2:#c4713b;--mu:#8a7e6f;--bd:#ddd5c8;--cd:#fff;--hl:#fff3cd;--tg:#f0e8db;--sh:rgba(44,36,22,.08);--err:#c0392b}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Crimson Pro',Georgia,serif;background:var(--bg);color:var(--fg);line-height:1.6}

/* Header */
header{background:var(--fg);color:var(--bg);padding:.8rem 1.2rem;display:flex;align-items:center;gap:1rem;flex-wrap:wrap}
header h1{font-size:1.3rem;font-weight:600;white-space:nowrap}
header h1 span{color:var(--ac2)}
.tabs{display:flex}.tab{padding:.35rem .9rem;cursor:pointer;border:1px solid var(--mu);background:0;color:var(--bg);font-family:inherit;font-size:.85rem;transition:.2s}
.tab:first-child{border-radius:4px 0 0 4px}.tab:last-child{border-radius:0 4px 4px 0}
.tab.act{background:var(--ac2);border-color:var(--ac2);font-weight:600}

/* Search */
.sbox{display:flex;gap:.3rem;flex-grow:1;max-width:420px}
.sbox input{flex:1;padding:.35rem .6rem;border:1px solid var(--mu);border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:.82rem;background:rgba(255,255,255,.1);color:var(--bg);outline:0}
.sbox input::placeholder{color:var(--mu)}.sbox input:focus{border-color:var(--ac2)}
.sbox button{padding:.35rem .7rem;background:var(--ac2);color:#fff;border:0;border-radius:4px;cursor:pointer;font-size:.82rem;font-family:inherit}
.sbox .rx{padding:.35rem .5rem;background:transparent;color:var(--mu);border:1px solid var(--mu);border-radius:4px;cursor:pointer;font-family:'JetBrains Mono',monospace;font-size:.75rem}
.sbox .rx.on{background:var(--ac2);color:#fff;border-color:var(--ac2)}

/* Controls */
.ctr{display:flex;align-items:center;gap:.8rem;color:var(--mu);font-size:.75rem;flex-wrap:wrap}
.ctr input[type=range]{width:60px;accent-color:var(--ac2)}
.mode-btn{padding:.2rem .5rem;border:1px solid var(--mu);border-radius:3px;cursor:pointer;font-size:.72rem;background:0;color:var(--mu)}
.mode-btn.act{background:var(--ac2);color:#fff;border-color:var(--ac2)}

/* Breadcrumb */
.bread{padding:.5rem 1.2rem;background:var(--cd);border-bottom:1px solid var(--bd);font-size:.85rem;display:flex;align-items:center;gap:.3rem;flex-wrap:wrap}
.bread a{color:var(--ac);cursor:pointer;text-decoration:none;font-weight:600}
.bread a:hover{text-decoration:underline}
.bread .sep{color:var(--mu)}

/* Info bar */
.info{padding:.35rem 1.2rem;font-size:.75rem;color:var(--mu);background:var(--cd);border-bottom:1px solid var(--bd);display:flex;gap:2rem}
.info b{color:var(--ac);font-family:'JetBrains Mono',monospace}

/* Letter grid */
.lgrid{display:flex;flex-wrap:wrap;gap:3px;padding:.6rem 1.2rem;background:var(--cd);border-bottom:1px solid var(--bd)}
.lbtn{min-width:36px;height:34px;display:flex;align-items:center;justify-content:center;border:1px solid var(--bd);border-radius:3px;cursor:pointer;font-family:'JetBrains Mono',monospace;font-size:.82rem;font-weight:600;background:var(--bg);color:var(--fg);transition:.15s;padding:0 .4rem}
.lbtn:hover{background:var(--ac2);color:#fff;border-color:var(--ac2)}
.lbtn.act{background:var(--ac);color:#fff;border-color:var(--ac)}
.lbtn .n{font-size:.6rem;color:var(--mu);margin-left:.2rem}
.lbtn.act .n{color:rgba(255,255,255,.7)}
.lbtn.err{border-color:var(--err);color:var(--err)}
.lbtn.err.act{background:var(--err);color:#fff}

main{max-width:1100px;margin:0 auto;padding:1rem 1.2rem}

.loading{text-align:center;padding:2rem;color:var(--mu);font-style:italic}
.loading::after{content:'';display:inline-block;width:16px;height:16px;border:2px solid var(--bd);border-top-color:var(--ac);border-radius:50%;animation:sp .7s linear infinite;margin-left:.4rem;vertical-align:middle}
@keyframes sp{to{transform:rotate(360deg)}}

/* Card */
.card{margin-bottom:.8rem;border:1px solid var(--bd);border-radius:5px;background:var(--cd);box-shadow:0 1px 2px var(--sh);overflow:hidden}
.ch{padding:.5rem .7rem;background:var(--tg);cursor:pointer;display:flex;align-items:center;gap:.4rem;user-select:none}
.ch:hover{background:var(--bd)}
.ar{font-size:.6rem;transition:transform .2s;color:var(--mu)}.op>.ar{transform:rotate(90deg)}
.cn{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:.95rem;color:var(--ac)}
.cm{font-size:.72rem;color:var(--mu);margin-left:auto;font-family:'JetBrains Mono',monospace}
.cb{display:none;padding:0 .7rem .5rem}.cb.op{display:block}

/* Form sub */
.fg{margin-top:.4rem}
.fh{padding:.2rem .35rem;cursor:pointer;display:flex;align-items:center;gap:.3rem;border-radius:3px;font-size:.88rem}
.fh:hover{background:var(--bg)}
.fh .ar{font-size:.5rem}
.fn{font-family:'JetBrains Mono',monospace;font-weight:600}
.fc{font-size:.68rem;color:var(--mu);background:var(--tg);padding:.05rem .3rem;border-radius:3px}
.fb{display:none;padding-left:1.2rem}.fb.op{display:block}

/* Context line */
.cl{padding:.15rem 0;font-size:.85rem;line-height:1.45;border-bottom:1px solid var(--bg);display:flex;align-items:baseline;gap:.2rem}
.cl:last-child{border-bottom:0}
.cp{font-family:'JetBrains Mono',monospace;font-size:.62rem;color:#fff;background:var(--ac);padding:.08rem .25rem;border-radius:2px;min-width:26px;text-align:center;flex-shrink:0}
.cx{color:var(--mu)}.ct{font-weight:600;color:var(--ac);background:var(--hl);padding:0 2px;border-radius:2px}
.ctx-hl{background:#ffd700;padding:0 1px;border-radius:1px}
.more{color:var(--mu);font-style:italic;font-size:.78rem;padding:.1rem 0}

/* List mode */
.list-row{display:flex;align-items:baseline;gap:.5rem;padding:.25rem .5rem;border-bottom:1px solid var(--bg);font-size:.88rem;cursor:pointer}
.list-row:hover{background:var(--tg)}
.list-lem{font-family:'JetBrains Mono',monospace;font-weight:600;color:var(--ac);min-width:140px}
.list-cnt{font-family:'JetBrains Mono',monospace;font-size:.72rem;color:var(--mu);min-width:50px;text-align:right}
.list-forms{font-size:.78rem;color:var(--mu)}
</style>
</head>
<body>

<header>
  <h1>İnce Memed <span>Lemma</span></h1>
  <div class="tabs">
    <button class="tab act" data-t="zeyrek" onclick="switchTab('zeyrek')">Zeyrek</button>
    <button class="tab" data-t="qwen" onclick="switchTab('qwen')">Qwen</button>
  </div>
  <div class="sbox">
    <input type="text" id="si" placeholder="Ara... (ör: vardı, koy.*, gel[imş]+)" 
           oninput="liveSearch()" onkeyup="if(event.key==='Enter')doSearch()">
    <button class="rx" id="rxbtn" onclick="toggleRx()" title="Regex modu">.*</button>
    <button onclick="doSearch()">Ara</button>
  </div>
  <div class="ctr">
    <label>±<span id="cv">5</span></label>
    <input type="range" id="cr" min="2" max="12" value="5" oninput="$('cv').textContent=this.value">
    <label>Maks:<span id="mv">8</span></label>
    <input type="range" id="mr" min="3" max="30" value="8" oninput="$('mv').textContent=this.value">
    <button class="mode-btn act" id="m_tree" onclick="setMode('tree')">Ağaç</button>
    <button class="mode-btn" id="m_list" onclick="setMode('list')">Liste</button>
  </div>
</header>
<div class="info" id="ib"></div>
<div class="bread" id="bc"></div>
<nav class="lgrid" id="ln"></nav>
<main id="co"><div class="loading">Veri yükleniyor</div></main>

<script>
const $=id=>document.getElementById(id);
const E=s=>s?s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'):'';

let D=null,TAB='zeyrek',IDX={},FIDX={},MODE='tree',RX=false;
let NAV=[]; // breadcrumb path: [{label,prefix}]

/* === Türkçe lowercase === */
function trLower(s){return s.replace(/İ/g,'i').replace(/I/g,'ı').toLowerCase()}

/* === DATA === */
async function init(){await loadData('zeyrek')}

async function loadData(tab){
  $('co').innerHTML='<div class="loading">Veri yükleniyor (~16 MB)</div>';
  D=null;IDX={};FIDX={};
  try{const r=await fetch('./'+tab+'.json');D=await r.json()}
  catch(e){$('co').innerHTML='<p>Yüklenemedi: '+e.message+'</p>';return}
  $('co').innerHTML='<div class="loading">İndeks oluşturuluyor</div>';
  await new Promise(r=>setTimeout(r,30));
  for(let i=0;i<D.length;i++){
    const[tok,lems]=D[i];
    const tl=trLower(tok);
    if(!FIDX[tl])FIDX[tl]=[];FIDX[tl].push(i);
    for(const lem of lems){
      const ll=trLower(lem);
      if(!IDX[ll])IDX[ll]=[];IDX[ll].push(i);
    }
  }
  updateInfo();
  NAV=[];
  showLevel('');
}

function updateInfo(){
  const nL=Object.keys(IDX).length,nT=Object.keys(FIDX).length;
  const errCount=Object.keys(IDX).filter(k=>k.startsWith('⚠')).length;
  $('ib').innerHTML=`<div>${TAB==='zeyrek'?'Zeyrek Morfolojik Analiz':'Qwen Lemmatizasyon'}</div>
    <div>Satır: <b>${D.length.toLocaleString()}</b></div>
    <div>Lemma: <b>${nL.toLocaleString()}</b></div>
    ${errCount?'<div style="color:var(--err)">Hatalı: <b>'+errCount+'</b></div>':''}`;
}

/* === PROGRESSIVE DRILL-DOWN === */
function showLevel(prefix){
  // prefix="" → A-Z harfler
  // prefix="a" → aa, ab, ac, ...
  // prefix="ab" → aba, abl, ...
  // prefix uzunca → lemma listesi göster
  
  updateBreadcrumb(prefix);
  
  // Bu prefix ile başlayan tüm lemmaları bul
  const matching=[];
  const isError = prefix === '⚠';
  
  const PUNC=/^[^a-zA-ZçÇğĞıİöÖşŞüÜâÂîÎûÛ⚠]/;
  for(const lem of Object.keys(IDX)){
    if(PUNC.test(lem))continue; // noktalama lemmalarını atla
    if(isError){
      if(lem.startsWith('⚠')) matching.push(lem);
    } else if(prefix===''){
      matching.push(lem);
    } else {
      if(trLower(lem).startsWith(prefix.toLowerCase()) && !lem.startsWith('⚠')) matching.push(lem);
    }
  }
  
  if(prefix===''||isError){
    // İlk harf bazlı grupla
    const groups={};
    for(const lem of matching){
      const key=isError?'⚠':trLower(lem)[0]?.toUpperCase()||'_';
      const normKey=trNormalize(key);
      if(!groups[normKey])groups[normKey]={count:0,uses:0};
      groups[normKey].count++;
      groups[normKey].uses+=IDX[lem].length;
    }
    renderLetterGrid(groups,prefix,isError);
    $('co').innerHTML=`<p style="color:var(--mu);padding:1rem">Bir harf seçin veya arama yapın. ${matching.length.toLocaleString()} lemma mevcut.</p>`;
  } else if(prefix.length < 4 && matching.length > 60){
    // Alt gruplar göster (prefix+1 harf) — 4 karakter derinliğe kadar
    const groups={};
    const plen=prefix.length;
    for(const lem of matching){
      const ll=trLower(lem);
      const key=ll.substring(0,plen+1);
      if(!groups[key])groups[key]={count:0,uses:0};
      groups[key].count++;
      groups[key].uses+=IDX[lem].length;
    }
    renderSubGrid(groups,prefix);
    $('co').innerHTML=`<p style="color:var(--mu);padding:1rem">${matching.length} lemma — alt grup seçin.</p>`;
  } else {
    // Lemma listesi göster
    $('ln').innerHTML='';
    matching.sort((a,b)=>a.localeCompare(b,'tr'));
    if(MODE==='tree') renderTree(matching);
    else renderList(matching);
  }
}

function trNormalize(c){
  const map={'ç':'C','Ç':'C','ğ':'G','Ğ':'G','ı':'I','İ':'I','i':'I','I':'I',
             'ö':'O','Ö':'O','ş':'S','Ş':'S','ü':'U','Ü':'U','â':'A','Â':'A','î':'I','Î':'I','û':'U','Û':'U'};
  const up=c.toUpperCase();
  return map[c]||map[up]||up;
}

function updateBreadcrumb(prefix){
  let html='<a onclick="showLevel(\'\')">⌂</a>';
  if(prefix){
    for(let i=1;i<=prefix.length;i++){
      const p=prefix.substring(0,i);
      html+=`<span class="sep">›</span><a onclick="showLevel('${E(p)}')">${E(p.toUpperCase())}</a>`;
    }
  }
  $('bc').innerHTML=html;
}

function renderLetterGrid(groups,prefix,isError){
  const trOrder='ABCÇDEFGĞHIİJKLMNOÖPRSŞTUÜVYZ';
  let letters=Object.keys(groups);
  // Türkçe sırala
  letters.sort((a,b)=>{
    const ai=trOrder.indexOf(a),bi=trOrder.indexOf(b);
    if(ai>=0&&bi>=0)return ai-bi;
    if(ai>=0)return -1;if(bi>=0)return 1;
    return a.localeCompare(b);
  });
  
  let html=letters.map(l=>{
    const g=groups[l];
    return`<button class="lbtn" onclick="showLevel('${E(trLower(l))}')">${l}<span class="n">${g.count}</span></button>`;
  }).join('');
  
  // Hatalı butonu (Qwen tab)
  if(!isError && TAB==='qwen'){
    const errLems=Object.keys(IDX).filter(k=>k.startsWith('⚠'));
    if(errLems.length)
      html+=`<button class="lbtn err" onclick="showLevel('⚠')">⚠<span class="n">${errLems.length}</span></button>`;
  }
  $('ln').innerHTML=html;
}

function renderSubGrid(groups,prefix){
  const keys=Object.keys(groups).sort((a,b)=>a.localeCompare(b,'tr'));
  $('ln').innerHTML=keys.map(k=>{
    const g=groups[k];
    return`<button class="lbtn" onclick="showLevel('${E(k)}')">${E(k)}<span class="n">${g.count}</span></button>`;
  }).join('');
}

/* === RENDER TREE === */
function renderTree(lemmaKeys){
  const mx=+$('mr').value;
  let h='';
  for(const lem of lemmaKeys){
    const indices=IDX[lem];if(!indices)continue;
    const forms={};
    for(const i of indices){const fl=trLower(D[i][0]);if(!forms[fl])forms[fl]=[];forms[fl].push(i)}
    const fk=Object.keys(forms).sort((a,b)=>a.localeCompare(b,'tr'));
    const displayLem=lem.startsWith('⚠')?lem.substring(1):lem;
    const isErr=lem.startsWith('⚠');
    
    h+=`<div class="card"><div class="ch" onclick="tog(this)">
      <span class="ar">▶</span>
      <span class="cn"${isErr?' style="color:var(--err)"':''}>${E(displayLem)}</span>
      ${isErr?'<span style="font-size:.7rem;color:var(--err)">hatalı</span>':''}
      <span class="cm">${fk.length} form · ${indices.length}×</span>
    </div><div class="cb">`;
    for(const form of fk){
      const fl=forms[form],n=fl.length;
      h+=`<div class="fg"><div class="fh" onclick="tog(this)">
        <span class="ar">▶</span><span class="fn">${E(form)}</span><span class="fc">${n}×</span>
      </div><div class="fb">`;
      for(let k=0;k<Math.min(n,mx);k++) h+=ctxHTML(fl[k]);
      if(n>mx) h+=`<div class="more">… +${n-mx}</div>`;
      h+='</div></div>';
    }
    h+='</div></div>';
  }
  $('co').innerHTML=h||'<p>Sonuç yok.</p>';
}

/* === RENDER LIST === */
function renderList(lemmaKeys){
  let h='<div style="border:1px solid var(--bd);border-radius:5px;background:var(--cd);overflow:hidden">';
  for(const lem of lemmaKeys){
    const indices=IDX[lem];if(!indices)continue;
    const forms=new Set();
    for(const i of indices) forms.add(trLower(D[i][0]));
    const displayLem=lem.startsWith('⚠')?lem.substring(1):lem;
    const isErr=lem.startsWith('⚠');
    h+=`<div class="list-row" onclick="drillLemma('${E(lem.replace(/'/g,"\\'"))}')">
      <span class="list-lem"${isErr?' style="color:var(--err)"':''}>${E(displayLem)}</span>
      <span class="list-cnt">${indices.length}×</span>
      <span class="list-forms">${[...forms].slice(0,8).map(f=>E(f)).join(', ')}${forms.size>8?' …':''}</span>
    </div>`;
  }
  h+='</div>';
  $('co').innerHTML=h;
}

function drillLemma(lem){
  MODE='tree';$('m_tree').classList.add('act');$('m_list').classList.remove('act');
  renderTree([lem]);
  // Auto-open first
  const first=$('co').querySelector('.ch');
  if(first){first.classList.add('op');first.nextElementSibling.classList.add('op')}
}

/* === CONTEXT === */
function ctxHTML(linenum,highlight){
  const w=+$('cr').value;
  const[tok,,pg]=D[linenum];
  const left=[],right=[];
  for(let j=linenum-1;left.length<w&&j>=0;j--){if(D[j][2]!==pg)break;left.unshift(D[j][0])}
  for(let j=linenum+1;right.length<w&&j<D.length;j++){if(D[j][2]!==pg)break;right.push(D[j][0])}
  
  let lText=E(left.join(' ')),rText=E(right.join(' '));
  if(highlight){
    try{
      const re=new RegExp('('+highlight+')','gi');
      lText=lText.replace(re,'<span class="ctx-hl">$1</span>');
      rText=rText.replace(re,'<span class="ctx-hl">$1</span>');
    }catch(e){}
  }
  
  return`<div class="cl"><span class="cp">${pg}</span><span class="cx">${lText}</span><span class="ct">${E(tok)}</span><span class="cx">${rText}</span></div>`;
}

/* === SEARCH === */
let searchTimeout;
function liveSearch(){
  clearTimeout(searchTimeout);
  const q=$('si').value.trim();
  if(!q||!D)return;
  if(!RX && q.length<=4){
    // 4 karaktere kadar drill-down gibi davran
    showLevel(trLower(q));
    return;
  }
  if(q.length<2)return;
  searchTimeout=setTimeout(()=>doSearch(true),300);
}

function doSearch(isLive){
  const raw=$('si').value.trim();
  if(!raw||!D)return;
  const q=trLower(raw);
  const mx=+$('mr').value;
  
  let h='';
  
  if(RX){
    // Regex arama — lemma, token ve bağlam üzerinde
    let re;
    try{re=new RegExp(q,'i')}catch(e){$('co').innerHTML='<p style="color:var(--err)">Geçersiz regex: '+E(e.message)+'</p>';return}
    
    // 1) Lemma eşleşme
    const lemMatches=Object.keys(IDX).filter(l=>re.test(l));
    // 2) Token eşleşme
    const tokMatches=Object.keys(FIDX).filter(t=>re.test(t));
    
    h+=`<h2 style="margin-bottom:.8rem;color:var(--ac)">Regex: /${E(raw)}/</h2>`;
    
    if(lemMatches.length>0){
      h+=`<h3 style="color:var(--mu);margin:.5rem 0">Lemma eşleşmeleri (${lemMatches.length})</h3>`;
      lemMatches.sort((a,b)=>a.localeCompare(b,'tr'));
      for(const lem of lemMatches.slice(0,50)){
        const indices=IDX[lem];
        h+=`<div class="card"><div class="ch" onclick="tog(this)"><span class="ar">▶</span>
          <span class="cn">${E(lem.replace(/⚠/,''))}</span><span class="cm">${indices.length}×</span>
        </div><div class="cb">`;
        for(let k=0;k<Math.min(indices.length,mx);k++) h+=ctxHTML(indices[k],raw);
        if(indices.length>mx) h+=`<div class="more">… +${indices.length-mx}</div>`;
        h+='</div></div>';
      }
      if(lemMatches.length>50) h+=`<div class="more">… +${lemMatches.length-50} lemma</div>`;
    }
    
    if(tokMatches.length>0){
      const uniqueTok=new Set(tokMatches);
      const lemmaOfTok=new Set();
      for(const t of tokMatches)for(const i of FIDX[t])for(const l of D[i][1])lemmaOfTok.add(trLower(l));
      
      h+=`<h3 style="color:var(--mu);margin:.5rem 0">Token eşleşmeleri (${tokMatches.length} form)</h3>`;
      for(const tok of tokMatches.slice(0,30)){
        const lines=FIDX[tok];
        h+=`<div class="card"><div class="ch" onclick="tog(this)"><span class="ar">▶</span>
          <span class="fn">${E(tok)}</span><span class="cm">${lines.length}×</span>
        </div><div class="cb">`;
        for(let k=0;k<Math.min(lines.length,mx);k++) h+=ctxHTML(lines[k],raw);
        if(lines.length>mx) h+=`<div class="more">… +${lines.length-mx}</div>`;
        h+='</div></div>';
      }
    }
    
    // 3) Bağlam araması (yavaş, sadece Enter ile)
    if(!isLive && lemMatches.length===0 && tokMatches.length===0){
      h+=`<h3 style="color:var(--mu);margin:.5rem 0">Bağlamda aranıyor...</h3>`;
      const ctxResults=[];
      for(let i=0;i<D.length&&ctxResults.length<100;i++){
        if(re.test(D[i][0])) ctxResults.push(i);
      }
      if(ctxResults.length>0){
        h+=`<div class="card"><div class="ch op"><span class="ar" style="transform:rotate(90deg)">▶</span>
          <span class="cn">Bağlam sonuçları</span><span class="cm">${ctxResults.length}×</span>
        </div><div class="cb op">`;
        for(const i of ctxResults.slice(0,mx)) h+=ctxHTML(i,raw);
        h+='</div></div>';
      }
    }
    
    if(!h.includes('card'))h+='<p>Sonuç bulunamadı.</p>';
    
  } else {
    // Normal arama
    h+=`<h2 style="margin-bottom:.8rem;color:var(--ac)">Arama: "${E(raw)}"</h2>`;
    
    // Token eşleşme
    if(FIDX[q]){
      const lines=FIDX[q];
      const lemSet=new Set();
      for(const i of lines)for(const l of D[i][1])lemSet.add(l);
      
      h+=`<div class="card"><div class="ch op"><span class="ar" style="transform:rotate(90deg)">▶</span>
        <span class="fn">${E(raw)}</span>
        <span class="cm">token · ${lines.length}× · lemmalar: ${[...lemSet].map(l=>'<b>'+E(l)+'</b>').join(', ')}</span>
      </div><div class="cb op">`;
      
      for(const lem of [...lemSet].sort()){
        const sub=lines.filter(i=>D[i][1].map(l=>trLower(l)).includes(trLower(lem)));
        h+=`<div class="fg"><div class="fh op"><span class="ar" style="transform:rotate(90deg)">▶</span>
          <span class="fn">→ ${E(lem)}</span><span class="fc">${sub.length}×</span>
        </div><div class="fb op">`;
        for(let k=0;k<Math.min(sub.length,mx);k++) h+=ctxHTML(sub[k]);
        if(sub.length>mx) h+=`<div class="more">… +${sub.length-mx}</div>`;
        h+='</div></div>';
      }
      h+='</div></div>';
    }
    
    // Lemma tam eşleşme
    if(IDX[q]){
      const indices=IDX[q];
      const forms={};
      for(const i of indices){const fl=trLower(D[i][0]);if(!forms[fl])forms[fl]=[];forms[fl].push(i)}
      h+=`<div class="card"><div class="ch op"><span class="ar" style="transform:rotate(90deg)">▶</span>
        <span class="cn">${E(raw)}</span><span class="cm">lemma · ${Object.keys(forms).length} form · ${indices.length}×</span>
      </div><div class="cb op">`;
      for(const form of Object.keys(forms).sort((a,b)=>a.localeCompare(b,'tr'))){
        const fl=forms[form];
        h+=`<div class="fg"><div class="fh" onclick="tog(this)"><span class="ar">▶</span>
          <span class="fn">${E(form)}</span><span class="fc">${fl.length}×</span>
        </div><div class="fb">`;
        for(let k=0;k<Math.min(fl.length,mx);k++) h+=ctxHTML(fl[k]);
        if(fl.length>mx) h+=`<div class="more">… +${fl.length-mx}</div>`;
        h+='</div></div>';
      }
      h+='</div></div>';
    }
    
    // Kısmi eşleşme
    const partials=Object.keys(IDX).filter(l=>l!==q&&l.includes(q)).sort((a,b)=>a.localeCompare(b,'tr'));
    if(partials.length>0){
      h+=`<h3 style="color:var(--mu);margin:.8rem 0 .4rem">Kısmi (${partials.length})</h3>`;
      for(const lem of partials.slice(0,30)){
        h+=`<div style="padding:.15rem .4rem;cursor:pointer;color:var(--ac);font-family:'JetBrains Mono',monospace;font-size:.85rem" 
             onclick="$('si').value='${E(lem.replace(/'/g,"\\'"))}';doSearch()">${E(lem)} <span style="color:var(--mu)">(${IDX[lem].length}×)</span></div>`;
      }
      if(partials.length>30) h+=`<div class="more">… +${partials.length-30}</div>`;
    }
    
    if(!FIDX[q]&&!IDX[q]&&partials.length===0) h+='<p>Sonuç bulunamadı.</p>';
  }
  
  $('co').innerHTML=h;
}

/* === UI === */
function tog(el){el.classList.toggle('op');el.nextElementSibling.classList.toggle('op')}
function switchTab(tab){
  TAB=tab;
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('act',t.dataset.t===tab));
  loadData(tab);
}
function setMode(m){
  MODE=m;
  $('m_tree').classList.toggle('act',m==='tree');
  $('m_list').classList.toggle('act',m==='list');
  // Re-render if on a lemma page
  const bc=$('bc').textContent;
  if(bc.length>1)showLevel(NAV.length?NAV[NAV.length-1]:'');
}
function toggleRx(){RX=!RX;$('rxbtn').classList.toggle('on',RX);$('si').placeholder=RX?'Regex ara... (ör: gel[imş]+, koy.*mak)':'Ara... (ör: vardı, koyun, gelmek)'}

init();
</script>
</body>
</html>
